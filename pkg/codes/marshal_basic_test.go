package codes

import (
	"bytes"
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestMarshalBasic(t *testing.T) {
	testMarshalBasic(t, []byte{0x81, 0x7, 0x10, 0x5, 0x79, 0x2d, 0x6e, 0x65, 0x77}, "y-new")
	testMarshalBasic(t, []byte{0x81, 0x3, 0x10, 0x1, 0x2}, int32(2))
	testMarshalBasic(t, []byte{0x81, 0x3, 0x10, 0x1, 0x2}, uint32(2))
	testMarshalBasic(t, []byte{0x81, 0x3, 0x10, 0x1, 0x0}, int64(0))
	testMarshalBasic(t, []byte{0x81, 0x3, 0x10, 0x1, 0x2}, uint64(2))
	testMarshalBasic(t, []byte{0x81, 0x4, 0x10, 0x2, 0x3e, 0xc0}, float32(0.375))
	testMarshalBasic(t, []byte{0x81, 0x4, 0x10, 0x2, 0x40, 0x37}, float64(23))

	testMarshalBasicArray(t, []byte{0x81, 0xb, 0xd0, 0x9, 0x0, 0x1, 0x61, 0x0, 0x1, 0x62, 0x0, 0x1, 0x63}, []string{"a", "b", "c"})
	testMarshalBasicArray(t, []byte{0x81, 0xb, 0xd0, 0x9, 0x0, 0x1, 0x1, 0x0, 0x1, 0x2, 0x0, 0x1, 0x7f}, []int32{int32(1), int32(2), int32(-1)})
	testMarshalBasicArray(t, []byte{0x81, 0xb, 0xd0, 0x9, 0x0, 0x1, 0x1, 0x0, 0x1, 0x2, 0x0, 0x1, 0x3}, []uint32{uint32(1), uint32(2), uint32(3)})
	testMarshalBasicArray(t, []byte{0x81, 0xb, 0xd0, 0x9, 0x0, 0x1, 0x1, 0x0, 0x1, 0x2, 0x0, 0x1, 0x7f}, []int64{int64(1), int64(2), int64(-1)})
	testMarshalBasicArray(t, []byte{0x81, 0xb, 0xd0, 0x9, 0x0, 0x1, 0x1, 0x0, 0x1, 0x2, 0x0, 0x1, 0x3}, []uint64{uint64(1), uint64(2), uint64(3)})
	testMarshalBasicArray(t, []byte{0x81, 0xa, 0xd0, 0x8, 0x0, 0x2, 0x3e, 0x80, 0x0, 0x2, 0x3e, 0xc0}, []float32{float32(0.25), float32(0.375)})
	testMarshalBasicArray(t, []byte{0x81, 0x9, 0xd0, 0x7, 0x0, 0x2, 0x3f, 0xf0, 0x0, 0x1, 0xc0}, []float64{float64(1), float64(-2)})
}

func testMarshalBasic(t *testing.T, expected []byte, T interface{}) {
	var msg = fmt.Sprintf("tester %v, (%v)", expected, T)
	proto := NewProtoCodec(0x10)
	buf, _ := proto.Marshal(T)
	//fmt.Printf("#000 testMarshalBasic Kind=%v, buf=%v\n", reflect.ValueOf(T).Kind(), packetutils.FormatBytes(buf))
	assert.True(t, bytes.Equal(expected, buf), msg)
}

func testMarshalBasicArray(t *testing.T, expected []byte, T interface{}) {
	var msg = fmt.Sprintf("tester %v, (%v)", expected, T)
	proto := NewProtoCodec(0x10)
	buf, _ := proto.Marshal(T)
	//fmt.Printf("#000 testMarshalBasicArray Kind=%v, Elem=%v, buf=%v\n", reflect.ValueOf(T).Kind(), reflect.ValueOf(T).Index(0).Kind(), packetutils.FormatBytes(buf))
	assert.True(t, bytes.Equal(expected, buf), msg)
}
